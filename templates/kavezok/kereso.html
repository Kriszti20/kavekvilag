{% load static %}
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kávé kereső</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        body {
            background-color: #1f4037;
            color: white;
            font-family: 'Georgia', serif;
            margin: 0;
        }
        header {
            background-color: #1c2824;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .logo {
            font-size: 1.8rem;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }
        nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        nav a {
            color: white;
            text-decoration: none;
            font-size: 1rem;
            font-weight: bold;
            transition: color 0.3s;
        }
        nav a:hover {
            color: #cf9775;
        }
        .user-info {
            margin-left: 16px;
            color: #ffa;
            font-weight: bold;
        }
        .logout-form {
            display: inline;
            margin-left: 8px;
        }
        .logout-form button {
            background: none;
            border: none;
            color: white;
            text-decoration: underline;
            cursor: pointer;
            font-size: 1rem;
            font-family: inherit;
        }
        main {
            text-align: center;
            margin-top: 36px;
        }
        .search-form {
            max-width: 400px;
            margin: 30px auto 0 auto;
            background-color: #2d4239;
            border-radius: 15px; 
            padding: 24px 22px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.18);
        }
        .search-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
        }
        .search-form input[type="text"] {
            width:100%;
            background-color: #162722;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-bottom:18px;
            font-size: 1rem;
        }
        .search-form button {
            background-color:#dfa26f; 
            color:white; 
            width:99%; 
            padding:11px 0; 
            border:none; 
            border-radius:5px;
            cursor:pointer;
            font-size:1.05rem;
            font-family:inherit;
        }
        .search-form button:hover { background-color:#c88b5f; }
        #kavezo-lista {
            max-width: 550px;
            margin: 32px auto 0 auto;
            text-align: left;
        }
        .kavezo-card {
            background: #264330;
            border-radius: 8px;
            margin: 14px 0;
            padding: 15px 18px;
            box-shadow: 0 1px 8px #0002;
        }
        .kavezo-card h3 {
            margin:0 0 3px 0;
            color:#F9BE7C;
        }
        .reszletek-btn {
            display: inline-block;
            margin-top: 7px;
            padding: 6px 16px;
            background: #f9be7c;
            border-radius: 7px;
            color: #133929;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.17s;
        }
        .reszletek-btn:hover {
            background: #fde3c6;
        }
        .kavezo-card p { margin:3px 0; color:#eee;}
        .search-form select {
            width: 100%;
            background-color: #162722;
            color: #fff;
            padding: 9px 8px;
            border: none;
            border-radius: 5px;
            margin-bottom: 16px;
            font-size: 1rem;
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            box-shadow: none;
        }
        .search-form option {
            background: #162722;
            color: #fff;
        }
        .search-form select {
            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='12' viewBox='0 0 20 20' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M7.293 7.293a1 1 0 011.414 0L10 8.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 18px 18px;
            padding-right: 28px;
        }
    </style>
</head>
<body>
<header>
    <div class="logo">Kávék világa</div>
    <nav>
        <a href="/">Kezdőlap</a>
        <a href="{% url 'kavezok:kereso' %}">Kávézók</a>
        <nav>
            <!-- egyéb menüpontok -->
            <a href="{% url 'kavezok:kosar_megjelenitese' %}">Kosár</a>
        </nav>
        <a href="{% url 'kavezok:foglalas_letrehozas' %}">Foglalás</a>
        {% if user.is_authenticated %}
            <div class="user-info">
                <a href="{% url 'kavezok:profil' %}"><span>Bejelentkezve: {{ user.username }}</span></a>
                <form method="post" action="{% url 'kavezok:logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit">Kijelentkezés</button>
                </form>
            </div>
        {% else %}
            <a href="{% url 'kavezok:bejelentkezes' %}">Bejelentkezés</a>
        {% endif %}
    </nav>
</header>
<main>
    <div class="search-form">
        <form id="kavezo-kereso-form">
            <label for="helyszin">Helyszín</label>
            <input type="text" id="helyszin" name="helyszin" placeholder="Város vagy cím">
            <label for="nev">Név</label>
            <input type="text" id="nev" name="nev" placeholder="Kávézó neve">
            <label for="arszint">Árszint</label>
            <select id="arszint" name="arszint">
            <option value="">-- Mindegy --</option>
            <option value="olcso">Olcsó</option>
            <option value="kozepes">Közepes</option>
            <option value="draga">Drága</option>
            </select>

            <label for="min_rating">Minimális értékelés</label>
            <select id="min_rating" name="min_rating">
            <option value="">-- Mindegy --</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
            <option value="4.5">4.5+</option>
            </select>
            <button type="submit" id="kereses-btn">Keresés</button>
            <button type="button" id="kereso-btn" style="margin-top:10px;width:99%;background:#dfa26f;">Közeli kávézók</button>
        </form>
    </div>
    <div id="kavezo-lista"></div>
</main>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAcygYCWGVfayOaUE9ruTUoi6F7XeyFxn0&libraries=places"></script>
<script>
// Google helyszín autocomplete
function initGoogleAutocomplete() {
    var input = document.getElementById('helyszin');
    const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['geocode'],
        componentRestrictions: { country: 'hu' }
    });
}
google.maps.event.addDomListener(window, 'load', initGoogleAutocomplete);

// Helyszín szerinti keresés
document.getElementById('kavezo-kereso-form').onsubmit = function(event) {
    event.preventDefault();
    const hely = document.getElementById('helyszin').value;
    const nev = document.getElementById('nev').value;
    const arszint = document.getElementById('arszint').value;
    const minRating = document.getElementById('min_rating').value;
    const listaDiv = document.getElementById('kavezo-lista');

    if (!hely && !nev && !arszint && !minRating) { 
        listaDiv.innerHTML = "<p style='color:#fa0'>Adj meg legalább egy szűrési feltételt!</p>";
        return; 
    }
    listaDiv.innerHTML = "Keresek…";
    let url = '/api/kavezok_kereso_api?';
    function addParam(existing, key, value) {
        return existing + (existing.endsWith('?') ? '' : '&') + key + '=' + encodeURIComponent(value);
    }

    // Ha hely van, azt geokódolni kell
    if (hely) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({address: hely}, function(results, status){
            if (status !== "OK" || !results[0]) { 
                listaDiv.innerHTML = "<p style='color:#fa0'>Helyszín nem található.</p>"; 
                return; 
            }
            const loc = results[0].geometry.location;
            let fullUrl = url + `lat=${loc.lat()}&lng=${loc.lng()}`;
            if (nev) fullUrl = addParam(fullUrl, "nev", nev);
            if (arszint) fullUrl = addParam(fullUrl, "arszint", arszint);
            if (minRating) fullUrl = addParam(fullUrl, "min_rating", minRating);
            fetch_and_display(fullUrl);
        });
    } else {
        let fullUrl = url;
        if (nev) fullUrl = addParam(fullUrl, "nev", nev);
        if (arszint) fullUrl = addParam(fullUrl, "arszint", arszint);
        if (minRating) fullUrl = addParam(fullUrl, "min_rating", minRating);
        fetch_and_display(fullUrl);
    }

    function fetch_and_display(fullUrl) {
        fetch(fullUrl)
            .then(res => res.json())
            .then(data => {
                if (!data.results || !data.results.length) {
                    listaDiv.innerHTML = "<p style='color:#fa0'>Nincs találat.</p>";
                    return;
                }
                let html = "";
                data.results.forEach(kavezo => {
                    let cim = kavezo.vicinity || kavezo.formatted_address || kavezo.cim || "";
                    html += `<div class="kavezo-card">
                        <h3>${kavezo.name || kavezo.nev}</h3>
                        <p>${cim}</p>
                        ${kavezo.rating ? `<p>⭐ ${kavezo.rating}</p>` : ''}
                        ${(typeof kavezo.price_level !== "undefined" && kavezo.price_level !== null) 
                            ? `<p>Árszint: ${["ingyenes", "olcsó", "közepes", "drága", "nagyon drága"][kavezo.price_level]}</p>`
                            : ''}
                        ${
                            kavezo.id 
                            ? `<a href="/kavezo/${kavezo.id}/">Részletek</a>`
                            : (kavezo.place_id 
                                ? `<a href="/kavezo/import-google/?place_id=${encodeURIComponent(kavezo.place_id)}&nev=${encodeURIComponent(kavezo.name)}&cim=${encodeURIComponent(cim)}">Részletek</a>`
                                : ''
                            )
                        }
                    </div>`;
                });
                listaDiv.innerHTML = html;
            });
    }
}; // !!! HIÁNYZOTT, ez az ONSUBMIT függvény ZÁRÁSA !!!

// Közeli kávézók gomb (GPS alapján)
document.getElementById("kereso-btn").onclick = function(){
    let listaDiv = document.getElementById("kavezo-lista");
    listaDiv.innerHTML = 
      "<p style='color:#F9BE7C;text-align:center;'>Pozíció meghatározása…</p>";
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos){
            let lat = pos.coords.latitude;
            let lng = pos.coords.longitude;
            reverseGeocode(lat, lng, function(cim){
                let helyszinSzoveg = cim ? `<div style="color:#dfa26f;text-align:center;margin-bottom:10px">Jelenlegi helyed: <b>${cim}</b></div>` : "";
                fetch(`/api/ajanlott_kavezok/?lat=${lat}&lng=${lng}`)
                    .then(r => r.json())
                    .then(data => {
                        let html = helyszinSzoveg;
                        if (data.kavezok && data.kavezok.length > 0) {
                            html += '<div style="text-align:center;color:#F9BE7C;font-size:1.3rem;margin-bottom:15px;">Közeli kávézók:</div>';
                            data.kavezok.slice(0, 10).forEach(function(kavezo){
                                html += `
                                    <div class="kavezo-card">
                                        <h2>
                                            <span style="color:#F9BE7C;">☕️ ${kavezo.nev}</span>
                                        </h2>
                                        <p><strong>Cím:</strong> ${kavezo.cim}</p>
                                        ${kavezo.rating !== undefined ? `<p><strong>Értékelés:</strong> <span style="color:gold">${kavezo.rating}</span></p>` : ``}
                                        <a href="/kavezo/import-google/?place_id=${encodeURIComponent(kavezo.place_id)}&nev=${encodeURIComponent(kavezo.nev || kavezo.name)}&cim=${encodeURIComponent(kavezo.cim || kavezo.formatted_address || "")}">Részletek</a>
                                    </div>
                                `;
                            });
                            listaDiv.innerHTML = html;
                        } else {
                            listaDiv.innerHTML = `<p class="no-result">Nincs találat a közeledben.</p>`;
                        }
                    });
            });
        }, function(){
            listaDiv.innerHTML = `<p class="no-result">Nem engedélyezted a helymeghatározást!</p>`;
        });
    } else {
        listaDiv.innerHTML = `<p class="no-result">A böngésződ nem támogatja a helymeghatározást.</p>`;
    }
}

// A fenti reverse geocode helper függvény:
function reverseGeocode(lat, lng, cb) {
    var geocoder = new google.maps.Geocoder();
    var latlng = {lat: lat, lng: lng};
    geocoder.geocode({'location': latlng}, function(results, status) {
        if (status === 'OK' && results[0]) {
            cb(results[0].formatted_address);
        } else {
            cb(null);
        }
    });
}
</script>

</body>
</html>